name: Deploy to K3s via ArgoCD

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - production
          - dev
      image_tag:
        description: 'Image tag (optional, default: latest commit SHA)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow to complete
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            const maxAttempts = 60;
            const waitTime = 20000;

            console.log(`Waiting for CI workflow to complete for SHA: ${sha}`);

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`\nAttempt ${attempt}/${maxAttempts}...`);

              // Get all check runs for this commit
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: sha
              });

              console.log(`Found ${checkRuns.check_runs.length} check runs`);

              // Find the docker check
              const dockerCheck = checkRuns.check_runs.find(
                check => check.name === 'docker' || check.name === 'CI / docker'
              );

              if (!dockerCheck) {
                console.log('âŒ Docker check not found yet, waiting...');
                await new Promise(resolve => setTimeout(resolve, waitTime));
                continue;
              }

              console.log(`Docker check status: ${dockerCheck.status}, conclusion: ${dockerCheck.conclusion}`);

              if (dockerCheck.status === 'completed') {
                if (dockerCheck.conclusion === 'success') {
                  console.log('âœ… CI workflow completed successfully!');
                  return;
                } else {
                  throw new Error(`âŒ CI workflow failed with conclusion: ${dockerCheck.conclusion}`);
                }
              }

              console.log('CI still running, waiting...');
              await new Promise(resolve => setTimeout(resolve, waitTime));
            }

            throw new Error('âŒ Timeout waiting for CI workflow to complete');
          github-token: ${{ secrets.GITHUB_TOKEN }}

  update-gitops:
    name: Update GitOps Manifests
    runs-on: ubuntu-latest
    needs: wait-for-ci
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: Determine image tag
        id: tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Update kustomization.yaml
        working-directory: k8s/overlays/${{ steps.env.outputs.environment }}
        env:
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ image tag Ð² kustomization.yaml
          kustomize edit set image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}

          echo "Updated kustomization.yaml:"
          cat kustomization.yaml

      - name: Commit and push changes
        env:
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add k8s/overlays/${ENVIRONMENT}/kustomization.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore(k8s): update ${ENVIRONMENT} image to ${IMAGE_TAG}" \
            -m "" \
            -m "Auto-updated by GitHub Actions" \
            -m "Workflow: ${{ github.workflow }}" \
            -m "Run: ${{ github.run_id }}"

          git push

      - name: Summary
        env:
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ GitOps Update Complete

          **Environment:** \`${ENVIRONMENT}\`
          **Image Tag:** \`${IMAGE_TAG}\`
          **Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}\`

          ### Next Steps

          1. **ArgoCD Sync**
             - ArgoCD will automatically detect and sync changes
             - Sync time: ~1-2 minutes
             - Check ArgoCD UI for status

          2. **Verify Deployment**
             \`\`\`bash
             kubectl get pods -n ozon-bot-${ENVIRONMENT}
             kubectl logs -f -l app=ozon-bot -n ozon-bot-${ENVIRONMENT}
             \`\`\`

          3. **Rollback (if needed)**
             - Via ArgoCD UI: History â†’ Select version â†’ Rollback
             - Via CLI: \`argocd app rollback ozon-bot-${ENVIRONMENT}\`

          ---

          **Deployed by:** @${{ github.actor }}
          **Commit:** ${{ github.sha }}
          EOF

  notify-argocd:
    name: Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    needs: update-gitops
    if: false

    steps:
      - name: Trigger ArgoCD sync
        run: |
          echo "ArgoCD will sync automatically (automated sync policy enabled)"
