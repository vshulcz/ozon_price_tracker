name: Deploy PR to Dev

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (e.g., sha-abc1234, latest, 0.4.1)'
        required: true
        type: string

jobs:
  validate:
    name: Validate Image Tag
    runs-on: ubuntu-latest
    steps:
      - name: Validate image tag format
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          echo "ðŸ“ Validating image tag: $IMAGE_TAG"

          # Basic validation
          if [[ -z "$IMAGE_TAG" ]]; then
            echo "âŒ Image tag is empty"
            exit 1
          fi

          echo "âœ… Image tag format validated"

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ Dev Deployment Validation

          **Image Tag:** \`${{ inputs.image_tag }}\`
          **Full Image:** \`ghcr.io/${{ github.repository }}:${{ inputs.image_tag }}\`

          Proceeding to update dev overlay...
          EOF

  deploy-to-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: dev
      url: https://github.com/${{ github.repository }}/deployments
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Update dev overlay
        working-directory: k8s/overlays/dev
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          set -euo pipefail

          echo "Updating dev overlay with PR image: ${IMAGE_TAG}"

          if [ ! -f "kustomization.yaml" ]; then
            echo "âŒ Dev overlay not found"
            exit 1
          fi

          cp kustomization.yaml kustomization.yaml.backup

          sed -i.bak "s|newTag:.*|newTag: ${IMAGE_TAG}|g" kustomization.yaml
          rm -f kustomization.yaml.bak

          echo "âœ… Updated dev overlay"
          echo "Changes:"
          diff kustomization.yaml.backup kustomization.yaml || true

      - name: Commit and push changes
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add k8s/overlays/dev/kustomization.yaml

          if git diff --staged --quiet; then
            echo "âš ï¸ No changes - image might already be deployed"
            exit 0
          fi

          git commit -m "deploy(k8s): deploy image $IMAGE_TAG to dev" \
            -m "" \
            -m "Deployed by: @${{ github.actor }}" \
            -m "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git push origin main

          echo "âœ… Dev overlay updated and committed"

      - name: Summary
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âœ… Deployed to Dev

          **Image:** \`ghcr.io/${{ github.repository }}:${IMAGE_TAG}\`
          **Namespace:** \`marketplace-bot-dev\`
          **Deployed by:** @${{ github.actor }}

          ### Next Steps

          1. **Monitor ArgoCD Sync** (~2-3 minutes)
             - ArgoCD detects Git changes automatically
             - Check status: \`argocd app get marketplace-bot-dev\`

          2. **Verify Deployment**
             \`\`\`bash
             kubectl get pods -n marketplace-bot-dev
             kubectl logs -f -l app=marketplace-price-tracker -n marketplace-bot-dev
             \`\`\`

          3. **Rollback if Needed**
             \`\`\`bash
             argocd app rollback marketplace-bot-dev
             \`\`\`

          ---

          **âš ï¸ Note:** Dev environment is shared. Deploying another image will overwrite this.
          EOF
